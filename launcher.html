<html>
<head>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        let playerName;  // Display name
        let myID;  // My peer ID, construed from the name
        let peer;  // My peer object

        // Connections to and names of all the other peers, keyed by peer ID
        const connections = {};
        const names = {};

        let groupIDNumber;  // Four-digit number
        let groupID;  // Hub peer ID, construed from the four-digit-number

        // Only hub uses these
        let groupPeer;  // Hub peer object, could be discarded after all peers connected
        const groupPeerIDs = [];  // All the IDs of the peers in group

        const sections = [
            "nameEntrySection",
            "nameDisplaySection",
            "groupEntrySection",
            "connectedPeersSection",
            "hubActionSection",
            "peerActionSection",
            "chatHistorySection",
            "chatEntrySection",
        ]

        function setPlayerName() {
            playerName = document.getElementById("player_name").value.trim();
            if (playerName === "") {
                alert("Fill name");
                return false
            }
            document.getElementById("showName").innerHTML = playerName;

            myID = makeID("player", playerName, true);

            return true;
        }

        function setGroupID() {
            groupIDNumber = document.getElementById("group_id").value.trim();

            if (groupIDNumber === "") {
                alert("Fill group number");
                return false;
            }

            groupID = makeID("group", groupIDNumber, false);

            return true;
        }

        function makeID(type, value, addRandom) {
            const noAccentValue = value.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const noSpacesValue = noAccentValue.replace(/ /g, '');
            const lowerCaseValue = noSpacesValue.toLowerCase();
            let randomNumber = "";
            if (addRandom) {
                randomNumber = Math.round(Math.random() * 10000).toString().padStart(4, '0') + "-";
            }
            return "soukantahti-" + type + "-id-" + randomNumber + lowerCaseValue;
        }

        function showSection(sectionIDsToShow) {
            sections.forEach((sectionIDToHide) => {
                document.getElementById(sectionIDToHide).style.display = "none";
            });
            sectionIDsToShow.forEach((sectionIDToShow) => {
                document.getElementById(sectionIDToShow).style.display = "inherit";
            });
        }

        function startAsHub() {
            if (!setPlayerName()) return;

            const gameIDDisplay = document.getElementById("showID");
            groupIDNumber = Math.round(Math.random() * 10000).toString().padStart(4, '0');
            gameIDDisplay.innerHTML = groupIDNumber;
            groupID = makeID("group", groupIDNumber, false);

            createMe();

            groupPeerIDs.push({peer: myID, name: playerName});

            groupPeer = new Peer(groupID);
            groupPeer.on("error", console.log);
            groupPeer.on("connection", connectionToHub);
            groupPeer.on("open", (conn) => {showSection([
                "nameDisplaySection", "connectedPeersSection", "chatHistorySection", "chatEntrySection"
            ])});
        }

        function createMe() {
            peer = new Peer(myID);
            peer.on("error", console.log);
            peer.on("connection", connectionToPeer);
        }

        function startAsPeer() {
            if (!setPlayerName()) return;

            showSection(["nameDisplaySection", "groupEntrySection"]);
        }

        function joinHub() {
            if (!setGroupID()) return;

            document.getElementById("showID").innerHTML = groupIDNumber;
            showSection(["nameDisplaySection", "connectedPeersSection"]);

            createMe();

            peer.on("open", (id) => {
                console.log("Client connecting to group ID " + groupID);
                const conn = peer.connect(groupID, {metadata: {name: playerName}});
                conn.on("error", console.log);
                conn.on("open", () => {
                    console.log("OPEN, setting data handler");
                    conn.on("data", messageReceived.bind(conn));
                });
                showSection(["nameDisplaySection", "connectedPeersSection", "chatHistorySection", "chatEntrySection"]);
            });
        }

        function connectionToHub(newConnection) {
            console.log("connectionToHub");
            newConnection.on("open", () => {
                newConnection.send({action: "connectToPeers", data: groupPeerIDs});
                groupPeerIDs.push({peer: newConnection.peer, name: newConnection.metadata.name});
            });
        }

        function connectionToPeer(newConnection) {
            console.log("connectionToPeer");
            newConnection.on("open", () => {
                connections[newConnection.peer] = newConnection;
                newConnection.on("data", messageReceived.bind(newConnection));
                refreshConnectionList();
            });
        }

        const handlers = {
            connectToPeers: function (connection, message) {
                console.log("connectToPeers");
                connection.close();
                message.forEach((peerData) => { openConnectionToPeer(peerData.peer, peerData.name); });
            },
            chat: function (connection, message) {
                displayMessage(message);
            },
        }

        function openConnectionToPeer(peerID, peerName) {
            if (!connections[peerID]) {
                const conn = peer.connect(peerID, {metadata: {name: playerName}});
                conn.on("open", () => {
                    connections[peerID] = conn;
                    conn.metadata.name = peerName;
                    refreshConnectionList();
                });
            }
        }

        function broadcast(message) {
            Object.values(connections).forEach((connection) => {
                console.log("Broadcasting to " + connection.peer + ": " + message);
                console.log("Connection is " + connection.open);
                connection.send(message);
            });
        }

        function messageReceived(message) {
            console.log("messageReceived");
            console.log(message);
            handlers[message.action](this, message.data);
        }

        function refreshConnectionList() {
            console.log("refreshConnectionList");
            console.log(connections);
            let peerIDList = ""
            Object.keys(connections).forEach((peerID) => {
                peerIDList += connections[peerID].metadata.name + " ";
            });
            document.getElementById("peerList").innerHTML = peerIDList;
        }

        function sendChat() {
            const inputElement = document.getElementById("chatInput");
            const chatMessage = inputElement.value.trim();
            inputElement.value = "";
            if (!chatMessage) return;

            const messageHTML = `<b>${playerName}</b><br/>${chatMessage}`;
            displayMessage(messageHTML, true);
            broadcast({action: "chat", data: messageHTML});
        }

        function displayMessage(message, onRight) {
            const messageElement = document.createElement("div");
            messageElement.style.width = "100%";
            if (onRight) {
                messageElement.style.textAlign = "right";
            }

            messageElement.innerHTML = message;
            document.getElementById("chatHistory").appendChild(messageElement);
            const scroller = document.getElementById("chatHistorySection");
            scroller.scrollTop = scroller.scrollHeight;
        }
    </script>
</head>
<body>
    <div id="nameEntrySection">
        <p>
            Your display name: <input id="player_name"/>
        </p>
        <p>
            <button type="button" onclick="startAsHub();">START</button>
            <button type="button" onclick="startAsPeer();">JOIN</button>
        </p>
    </div>
    <div id="nameDisplaySection" style="display: none;">
        Name: <span id="showName"></span>
    </div>
    <div id="groupEntrySection"  style="display: none;">
        <p>
            Group ID: <input id="group_id" type="number"/>
        </p>
        <p>
            <button type="button" onclick="joinHub();">JOIN</button>
        </p>
    </div>
    <div id="connectedPeersSection" style="display: none;">
        <p>
            Group ID: <span id="showID"></span>
        </p>
        <p>
            Connected to: <span id="peerList"></span>
        </p>
    </div>
    <div id="hubActionSection" style="display: none;">
        <p>
            <button type="button" onclick="allReadyToStart();">START</button>
            <button type="button" onclick="cancel();">CANCEL</button>
        </p>
    </div>
    <div id="peerActionSection"  style="display: none;">

    </div>
    <div id="chatHistorySection"
         style="display: none; width: 100%; height: 200px; overflow-y: scroll; padding: 10px;">
        <div id="chatHistory" style="width: 100%; height: 100%;"></div>
    </div>
    <div id="chatEntrySection" style="display: none; width: 100%;">
        <input id="chatInput" type="text" type="text" style="width: 100%;" />
        <button style="float: right;" onclick="sendChat();">SEND</button>
    </div>
</body>
</html>
