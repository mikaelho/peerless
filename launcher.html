<html>
<head>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        let playerName;
        let myID;
        let groupIDNumber;
        let groupID;

        let peer;
        let conn;

        const sections = [
            "nameEntrySection",
            "groupEntrySection",
            "connectedPeersSection",
            "hubActionSection",
            "peerActionSection",
            "",
        ]

        function setPlayerName() {
            playerName = document.getElementById("player_name").value.trim();
            if (playerName === "") {
                alert("Fill name");
                return false
            }
            myID = makeID("player", playerName, true);

            return true;
        }

        function setGroupID() {
            groupIDNumber = document.getElementById("group_id").value.trim();

            if (groupIDNumber === "") {
                alert("Fill group number");
                return false;
            }

            groupID = makeID("group", groupIDNumber, false);

            return true;
        }

        function makeID(type, value, addRandom) {
            const noAccentValue = value.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const noSpacesValue = noAccentValue.replace(/ /g, '');
            const lowerCaseValue = noSpacesValue.toLowerCase();
            let randomNumber = "";
            if (addRandom) {
                randomNumber = Math.round(Math.random() * 10000).toString().padStart(4, '0') + "-";
            }
            return "soukantahti-" + type + "-id-" + randomNumber + lowerCaseValue;
        }

        function showSection(sectionIDToShow) {
            sections.forEach((sectionIDToHide) => {
                document.getElementById(sectionIDToHide).style.display = "none";
            });
            document.getElementById(sectionIDToShow).style.display = "inherit";
        }

        function firstConnection(conn) {
            console.log("Connection");
            const peerID = conn.peer;
            console.log("Received peer connection from " + peerID);
        }

        function startAsHub() {
            if (!setPlayerName()) return;

            const gameIDDisplayArea = document.getElementById("game_id_display_area");
            groupIDNumber = Math.round(Math.random() * 10000).toString().padStart(4, '0');
            gameIDDisplayArea.innerHTML = "Group ID: " + groupIDNumber;
            gameIDDisplayArea.style.display = "inherit";
            groupID = makeID("group", groupIDNumber, false);

            peer = new Peer(groupID);
            peer.on("error", console.log);
            peer.on("connection", firstConnection);

            console.log("Hub started with group ID " + groupID);
        }

        function actualConnection(foobar) {
            console.log("Really open");
        }

        function startAsPeer() {
            if (!setPlayerName()) return;

            showSection("groupEntrySection");
        }

        function joinHub() {
            if (!setGroupID()) return;

            peer = new Peer(myID);
            peer.on("error", console.log);
            peer.on("open", (id) => {
                console.log("Client will connect to group ID " + groupID);
                conn = peer.connect(groupID);
                conn.on("open", actualConnection);
                conn.on("error", console.log);
            });
        }
    </script>
</head>
<body>
    <div id="nameEntrySection" style="display: none;">
        <p>
            Player name <input id="player_name"/>
        </p>
        <p>
            <button type="button" onclick="startAsHub();">START</button>
            <button type="button" onclick="startAsPeer();">JOIN</button>
        </p>
    </div>
    <div id="groupEntrySection">
        <p>
            Group ID <input id="group_id"/>
        </p>
        <p>
            <button type="button" onclick="joinHub();">JOIN</button>
        </p>
    </div>
    <div id="connectedPeersSection">

    </div>
    <div id="hubActionSection">

    </div>
    <div id="peerActionSection">

    </div>
</body>
</html>
